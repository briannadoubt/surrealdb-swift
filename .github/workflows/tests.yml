name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on macOS
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode 26.2
      run: sudo xcode-select -s /Applications/Xcode_26.2.app

    - name: Show Swift version
      run: swift --version

    - name: Run tests
      run: swift test

    - name: Build for release
      run: swift build -c release

  linux-test:
    name: Test on Ubuntu
    runs-on: ubuntu-latest
    container:
      image: swift:6.2

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show Swift version
      run: swift --version

    - name: Run tests
      run: swift test

    - name: Build for release
      run: swift build -c release

  integration-test-macos:
    name: Integration Tests on macOS
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode 26.2
      run: sudo xcode-select -s /Applications/Xcode_26.2.app

    - name: Show Swift version
      run: swift --version

    - name: Start SurrealDB
      run: |
        docker compose up -d
        echo "Waiting for SurrealDB to be healthy..."
        timeout 30s bash -c 'until docker compose ps | grep -q "healthy"; do sleep 2; done'
        echo "SurrealDB is ready!"

    - name: Run integration tests
      run: SURREALDB_TEST=1 swift test
      env:
        SURREALDB_TEST: "1"

    - name: Show SurrealDB logs on failure
      if: failure()
      run: docker compose logs

    - name: Stop SurrealDB
      if: always()
      run: docker compose down

  integration-test-linux:
    name: Integration Tests on Ubuntu
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: "6.0"

    - name: Show Swift version
      run: swift --version

    - name: Start SurrealDB
      run: |
        docker run -d --name surrealdb \
          -p 8000:8000 \
          surrealdb/surrealdb:latest \
          start --log trace --user root --pass root memory
        echo "Waiting for SurrealDB to be healthy..."
        sleep 5
        timeout 30s bash -c 'until curl -f http://localhost:8000/health 2>/dev/null; do sleep 2; done'
        echo "SurrealDB is ready!"

    - name: Run integration tests
      run: SURREALDB_TEST=1 swift test
      env:
        SURREALDB_TEST: "1"

    - name: Show SurrealDB logs on failure
      if: failure()
      run: docker logs surrealdb

    - name: Stop SurrealDB
      if: always()
      run: docker stop surrealdb && docker rm surrealdb
