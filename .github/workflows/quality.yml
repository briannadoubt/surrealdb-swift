name: Code Quality

on:
  pull_request:
    branches: [ main ]

jobs:
  swiftlint:
    name: SwiftLint
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: |
        if [ -f .swiftlint.yml ]; then
          swiftlint lint --strict
        else
          echo "SwiftLint configuration not found, skipping..."
        fi

  documentation:
    name: Documentation Check
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode 26.2
      run: sudo xcode-select -s /Applications/Xcode_26.2.app

    - name: Verify DocC builds
      run: |
        swift package plugin generate-documentation --target SurrealDB 2>&1 | tee doc-output.txt
        if grep -q "error:" doc-output.txt; then
          echo "Documentation generation failed"
          exit 1
        fi
        echo "Documentation generated successfully"

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Dependency audit
      run: |
        echo "üì¶ Checking dependencies..."

        # List all dependencies
        if [ -f Package.swift ]; then
          echo "Dependencies in Package.swift:"
          grep -A 20 "dependencies:" Package.swift | grep "package(url:" || echo "  No external dependencies found (DocC plugin only)"
        fi

        # Check for suspicious dependency URLs
        if grep -E "package\(url:.*\"(http://|git@)" Package.swift; then
          echo "‚ö†Ô∏è  WARNING: Found non-HTTPS dependency URL"
          exit 1
        fi

        echo "‚úÖ All dependencies use secure HTTPS URLs"

    - name: Secret scanning
      run: |
        echo "üîç Scanning for secrets and credentials..."

        FOUND_ISSUES=0

        # Check for API keys and tokens
        if grep -r -E "(sk-[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{36}|AKIA[0-9A-Z]{16})" --include="*.swift" .; then
          echo "‚ùå Found potential API keys or tokens"
          FOUND_ISSUES=1
        fi

        # Check for private keys
        if grep -r "BEGIN.*PRIVATE KEY" --include="*.swift" --include="*.pem" .; then
          echo "‚ùå Found private key material"
          FOUND_ISSUES=1
        fi

        # Check for AWS credentials
        if grep -r -E "aws_access_key_id|aws_secret_access_key" --include="*.swift" .; then
          echo "‚ùå Found AWS credentials"
          FOUND_ISSUES=1
        fi

        # Check for environment variables with credentials
        if grep -r -E "export.*=(.*password|.*secret|.*key)" --include="*.sh" .; then
          echo "‚ùå Found credentials in shell scripts"
          FOUND_ISSUES=1
        fi

        if [ $FOUND_ISSUES -eq 1 ]; then
          echo "‚ùå Security scan failed - found potential secrets"
          exit 1
        fi

        echo "‚úÖ No secrets or credentials found"

    - name: File permission check
      run: |
        echo "üîí Checking file permissions..."

        # Check for executable files that shouldn't be
        if find . -type f -name "*.swift" -perm -111 | grep -v ".build"; then
          echo "‚ö†Ô∏è  WARNING: Found executable Swift files (unusual)"
        fi

        echo "‚úÖ File permissions check complete"

    - name: License compliance
      run: |
        echo "üìú Checking for license compliance..."

        if [ ! -f LICENSE ]; then
          echo "‚ö†Ô∏è  WARNING: No LICENSE file found"
        else
          echo "‚úÖ LICENSE file present"
        fi
